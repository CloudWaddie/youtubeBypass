/*! For license information please see background.js.LICENSE.txt */
(()=>{function e(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return r(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,a=function(){};return{s:a,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,i=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){c=!0,u=e},f:function(){try{i||null==n.return||n.return()}finally{if(c)throw u}}}}function r(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function t(){var e,r,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",u=o.toStringTag||"@@toStringTag";function i(t,o,a,u){var i=o&&o.prototype instanceof s?o:s,l=Object.create(i.prototype);return n(l,"_invoke",function(t,n,o){var a,u,i,s=0,l=o||[],f=!1,d={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(r,t){return a=r,u=0,i=e,d.n=t,c}};function p(t,n){for(u=t,i=n,r=0;!f&&s&&!o&&r<l.length;r++){var o,a=l[r],p=d.p,b=a[2];t>3?(o=b===n)&&(i=a[(u=a[4])?5:(u=3,3)],a[4]=a[5]=e):a[0]<=p&&((o=t<2&&p<a[1])?(u=0,d.v=n,d.n=a[1]):p<b&&(o=t<3||a[0]>n||n>b)&&(a[4]=t,a[5]=n,d.n=b,u=0))}if(o||t>1)return c;throw f=!0,n}return function(o,l,b){if(s>1)throw TypeError("Generator is already running");for(f&&1===l&&p(l,b),u=l,i=b;(r=u<2?e:i)||!f;){a||(u?u<3?(u>1&&(d.n=-1),p(u,i)):d.n=i:d.v=i);try{if(s=2,a){if(u||(o="next"),r=a[o]){if(!(r=r.call(a,i)))throw TypeError("iterator result is not an object");if(!r.done)return r;i=r.value,u<2&&(u=0)}else 1===u&&(r=a.return)&&r.call(a),u<2&&(i=TypeError("The iterator does not provide a '"+o+"' method"),u=1);a=e}else if((r=(f=d.n<0)?i:t.call(n,d))!==c)break}catch(r){a=e,u=1,i=r}finally{s=1}}return{value:r,done:f}}}(t,a,u),!0),l}var c={};function s(){}function l(){}function f(){}r=Object.getPrototypeOf;var d=[][a]?r(r([][a]())):(n(r={},a,function(){return this}),r),p=f.prototype=s.prototype=Object.create(d);function b(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,n(e,u,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=f,n(p,"constructor",f),n(f,"constructor",l),l.displayName="GeneratorFunction",n(f,u,"GeneratorFunction"),n(p),n(p,u,"Generator"),n(p,a,function(){return this}),n(p,"toString",function(){return"[object Generator]"}),(t=function(){return{w:i,m:b}})()}function n(e,r,t,o){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}n=function(e,r,t,o){function u(r,t){n(e,r,function(e){return this._invoke(r,t,e)})}r?a?a(e,r,{value:t,enumerable:!o,configurable:!o,writable:!o}):e[r]=t:(u("next",0),u("throw",1),u("return",2))},n(e,r,t,o)}function o(e,r,t,n,o,a,u){try{var i=e[a](u),c=i.value}catch(e){return void t(e)}i.done?r(c):Promise.resolve(c).then(n,o)}function a(e){return function(){var r=this,t=arguments;return new Promise(function(n,a){var u=e.apply(r,t);function i(e){o(u,n,a,i,c,"next",e)}function c(e){o(u,n,a,i,c,"throw",e)}i(void 0)})}}var u=chrome||u;if(void 0===u)throw console.error("Browser API not available. This extension requires a compatible browser."),new Error("Browser API not available");var i="undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.getManifest&&3===chrome.runtime.getManifest().manifest_version,c="none",s=["youtube.com","m.youtube.com","www.youtube.com","youtubei.googleapis.com","youtube.googleapis.com","youtube-nocookie.com","www.youtube-nocookie.com"];function l(e){var r;switch(c){case"strict":r="Strict";break;case"moderate":r="Moderate";break;case"none":r="None";break;default:r="None-Spoof"}console.log("Setting YouTube-Restrict header to: ".concat(r));var t=e.requestHeaders||[],n=!1,o=t.map(function(e){return"youtube-restrict"===e.name.toLowerCase()?(n=!0,{name:"YouTube-Restrict",value:r}):e});return n||o.push({name:"YouTube-Restrict",value:r}),{requestHeaders:o}}function f(){return d.apply(this,arguments)}function d(){return(d=a(t().m(function e(){var r,n,o,a,l,f,d,p;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:if(i){e.n=1;break}return e.a(2);case 1:return e.p=1,console.log("Updating Chrome header rules..."),e.n=2,u.declarativeNetRequest.getDynamicRules();case 2:if(r=e.v,!((n=r.map(function(e){return e.id})).length>0)){e.n=3;break}return e.n=3,u.declarativeNetRequest.updateDynamicRules({removeRuleIds:n});case 3:o="strict"===c?"Strict":"moderate"===c?"Moderate":"None",console.log("Setting YouTube-Restrict header to:",o),console.log("Updating header rules with restriction:",o),a=s.flatMap(function(e,r){return[{id:2*r+1,priority:1,action:{type:"modifyHeaders",requestHeaders:[{header:"YouTube-Restrict",operation:"set",value:o}]},condition:{urlFilter:"||".concat(e,"/*"),resourceTypes:["main_frame","sub_frame","xmlhttprequest"]}},{id:2*r+2,priority:1,action:{type:"modifyHeaders",requestHeaders:[{header:"YouTube-Restrict",operation:"set",value:o}]},condition:{urlFilter:"*://*.".concat(e,"/*"),resourceTypes:["main_frame","sub_frame","xmlhttprequest"]}}]}),console.log("Updating rules:",a),l=20,f=0;case 4:if(!(f<a.length)){e.n=6;break}return d=a.slice(f,f+l),e.n=5,u.declarativeNetRequest.updateDynamicRules({addRules:d});case 5:f+=l,e.n=4;break;case 6:e.n=8;break;case 7:e.p=7,p=e.v,console.error("Error updating header rules:",p);case 8:return e.a(2)}},e,null,[[1,7]])}))).apply(this,arguments)}function p(){return b.apply(this,arguments)}function b(){return(b=a(t().m(function e(){return t().w(function(e){for(;;)switch(e.n){case 0:if(!i){e.n=1;break}return e.a(2);case 1:try{u.webRequest.onBeforeSendHeaders.removeListener(l),"none"!==c&&u.webRequest.onBeforeSendHeaders.addListener(l,{urls:s.map(function(e){return"*://*.".concat(e,"/*")}),types:["main_frame","sub_frame","xmlhttprequest"]},["blocking","requestHeaders"])}catch(e){console.error("Error updating Firefox headers:",e)}case 2:return e.a(2)}},e)}))).apply(this,arguments)}function v(){return(v=a(t().m(function e(){var r,n;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,u.storage.local.get("restrictionLevel");case 1:if(r=e.v,c=r.restrictionLevel||"none",console.log("Extension initialized with restriction level:",c),!i){e.n=3;break}return e.n=2,f();case 2:e.n=4;break;case 3:return e.n=4,p();case 4:e.n=6;break;case 5:e.p=5,n=e.v,console.error("Error initializing extension:",n);case 6:return e.a(2)}},e,null,[[0,5]])}))).apply(this,arguments)}function m(){return y.apply(this,arguments)}function y(){return(y=a(t().m(function r(){var n,o,a,i,c,s,l,f,d,p,b,v,m,y,h;return t().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,console.log("Finding YouTube tabs to reload..."),r.n=1,u.tabs.query({});case 1:n=r.v,o=n.filter(function(e){return e.url&&(e.url.includes("youtube.com")||e.url.includes("youtu.be"))}),console.log("Found ".concat(o.length," YouTube tabs to reload")),a=e(o),r.p=2,a.s();case 3:if((i=a.n()).done){r.n=9;break}return c=i.value,r.p=4,console.log("Reloading tab: ".concat(c.id," - ").concat(c.url)),r.n=5,new Promise(function(e){return setTimeout(e,100)});case 5:return r.n=6,u.tabs.reload(c.id);case 6:r.n=8;break;case 7:r.p=7,p=r.v,console.error("Error reloading tab ".concat(c.id,":"),p);case 8:r.n=3;break;case 9:r.n=11;break;case 10:r.p=10,b=r.v,a.e(b);case 11:return r.p=11,a.f(),r.f(11);case 12:console.log("Finished reloading YouTube tabs"),r.n=27;break;case 13:return r.p=13,v=r.v,console.error("Error in reloadYouTubeTabs:",v),r.p=14,r.n=15,u.tabs.query({});case 15:s=r.v,l=e(s),r.p=16,l.s();case 17:if((f=l.n()).done){r.n=22;break}if(!(d=f.value).url||!d.url.includes("youtube.com")&&!d.url.includes("youtu.be")){r.n=21;break}return r.p=18,r.n=19,u.tabs.reload(d.id);case 19:r.n=21;break;case 20:r.p=20,m=r.v,console.error("Secondary error reloading tab ".concat(d.id,":"),m);case 21:r.n=17;break;case 22:r.n=24;break;case 23:r.p=23,y=r.v,l.e(y);case 24:return r.p=24,l.f(),r.f(24);case 25:r.n=27;break;case 26:r.p=26,h=r.v,console.error("Secondary error in tab reload fallback:",h);case 27:return r.a(2)}},r,null,[[18,20],[16,23,24,25],[14,26],[4,7],[2,10,11,12],[0,13]])}))).apply(this,arguments)}u.runtime.onMessage.addListener(function(e,r,n){var o=function(){var e=a(t().m(function e(r,n){var o;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,"updateRestriction"!==r.action){e.n=6;break}return console.log("Updating restriction level to:",r.level),c=r.level,e.n=1,u.storage.local.set({restrictionLevel:r.level});case 1:if(!i){e.n=3;break}return e.n=2,f();case 2:e.n=4;break;case 3:return e.n=4,p();case 4:return console.log("Reloading YouTube tabs..."),e.n=5,m();case 5:return e.a(2,{status:"success",level:r.level});case 6:if("getRestriction"!==r.action){e.n=7;break}return e.a(2,{status:"success",level:c});case 7:return e.a(2,{status:"error",message:"Unknown action"});case 8:return e.p=8,o=e.v,console.error("Error handling message:",o),e.a(2,{status:"error",message:o.message})}},e,null,[[0,8]])}));return function(r,t){return e.apply(this,arguments)}}();return o(e,r).then(n),!0}),u.tabs.onUpdated.addListener(function(e,r,t){"complete"===r.status&&t.url&&s.some(function(e){return t.url.includes(e)})&&(console.log("YouTube page loaded, current restriction level:",c),i||p())}),function(){v.apply(this,arguments)}()})();